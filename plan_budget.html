1<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Plan Budget | DiNaDrawing</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="Assets/styles/scrollbar.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.css" rel="stylesheet">
<style>
      body { font-family: 'Poppins', sans-serif; background-color: #fffaf2; }
    #postInput:empty::before { content: attr(data-placeholder); color: #9ca3af; pointer-events: none; }
    #cropImage { max-width: 100%; display: block; }

    /* EDIT BANNER MODAL UI */
    .edit-modal-grid {
      --swatch-size: 36px; 
      display: grid;
      grid-template-columns: repeat(6, var(--swatch-size));
      gap: 10px;
      justify-content: center;
      align-items: center;
    }
    .gradient-circle, .color-picker-circle {
      width: var(--swatch-size); height: var(--swatch-size); border-radius: 9999px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.12);
      border: 2px solid rgba(255,255,255,0.75);
      display:flex; align-items:center; justify-content:center; cursor:pointer; overflow:hidden;
      transition: transform .12s ease;
    }
    .gradient-circle:hover, .color-picker-circle:hover { transform: scale(1.06); }
    .edit-modal { max-width: 520px; width: 92%; }
    #colorPicker {
      appearance: none; width: var(--swatch-size); height: var(--swatch-size); border-radius: 9999px;
      border: 2px solid rgba(255,255,255,0.75); padding: 0; cursor: pointer; background: transparent;
    }
    #colorPicker::-webkit-color-swatch { border: none; border-radius: 9999px; }
    #colorPicker::-moz-color-swatch { border: none; border-radius: 9999px; }
    .crop-aspect { aspect-ratio: 21/9; }

    /* SCROLLBAR STYLING + UTILITIES */
    html, body { scrollbar-gutter: stable; }
    * { scrollbar-width: thin; scrollbar-color: #f4b41a transparent; }
    *::-webkit-scrollbar { width: 8px; height: 8px; }
    *::-webkit-scrollbar-track { background: transparent; }
    *::-webkit-scrollbar-thumb { background-color: #f4b41a; border-radius: 9999px; border: 2px solid transparent; background-clip: padding-box; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .no-scrollbar::-webkit-scrollbar { display: none; }

    /* COLOR PICKER POPOVER STYLES */
    .swatch-popover {
      position: absolute;
      top: calc(var(--swatch-size) + 8px);
      left: 50%;
      transform: translateX(-50%);
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 8px;
      box-shadow: 0 10px 20px rgba(0,0,0,.12);
      z-index: 20;
    }
    .picker-donut {
      position: relative;
      background: conic-gradient(red, yellow, lime, cyan, blue, magenta, red);
    }
    .picker-donut::after {
      content: "";
      position: absolute;
      inset: 25%;
      background: white;
      border-radius: 9999px;
      box-shadow: inset 0 0 0 2px rgba(0,0,0,0.06);
    }
  </style>
</head>

<body class="flex bg-[#fffaf2] overflow-y-auto">

<!-- SIDEBAR -->
<aside id="sidebar"
class="fixed top-4 left-0 h-[calc(100vh-1rem)] w-64
       bg-[#f4b41a] rounded-tr-3xl
       p-6 shadow
       hidden md:flex md:flex-col md:gap-6">

  <!-- HEADER -->
  <div class="flex items-center gap-2">
    <img src="Assets/dinadrawing-logo.png" alt="Logo" class="w-14">
    <h2 class="text-xl font-bold text-[#222]">DiNaDrawing</h2>
  </div>

  <!-- NAVIGATIONS -->
  <nav>
    <ul class="space-y-5">
      <li><a href="dashboard.html" class="block px-4 py-2 rounded-lg font-medium text-[#222] hover:bg-[#222] hover:text-white transition">Home</a></li>
      <li><a href="myplans.html" class="block px-4 py-2 rounded-lg font-medium text-[#222] hover:bg-[#222] hover:text-white transition">My Plans</a></li>
      <li><a href="help.html" class="block px-4 py-2 rounded-lg font-medium text-[#222] hover:bg-[#222] hover:text-white transition">Help</a></li>
      <li><a href="settings.html" class="block px-4 py-2 rounded-lg font-medium text-[#222] hover:bg-[#222] hover:text-white transition">Settings</a></li>
    </ul>
  </nav>
</aside>

<!-- MAIN CONTENT -->
  <main class="ml-0 md:ml-64 flex-1 min-h-screen px-12 py-10 lg:mr-[23rem] lg:pr-4">
    <div
      class="fixed top-0 left-0 md:left-64 right-0 lg:right-[23rem] h-10 bg-[#fffaf2] z-30 pointer-events-none"
      aria-hidden="true"
    ></div>
    <div class="flex-1 w-full min-w-0">

      <!-- STICKY HEADER (Banner + Tabs) -->
      <div id="stickyHeader" class="sticky top-10 z-50 bg-[#fffaf2]">
        <!-- PLAN BANNER -->
        <div
          id="planBanner"
          class="group relative rounded-2xl px-8 font-bold text-3xl mb-3 shadow w-full overflow-hidden transition-colors duration-300 bg-cover bg-center py-20 lg:py-24 min-h-[12rem]"
          style="background: linear-gradient(to right, #3b82f6, #9333ea); color: #fff;"
        >
          <a href="myplans.html"
             class="absolute top-5 left-8 inline-flex items-center justify-center w-8 h-8 rounded-lg hover:bg-white/30 focus:outline-none focus-visible:ring-2 focus-visible:ring-[#f4b41a]"
             style="color: inherit;"
             aria-label="Back to My Plans">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                 class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2"
                 stroke-linecap="round" stroke-linejoin="round">
              <path d="M15 18l-6-6 6-6"/>
            </svg>
          </a>
          <span id="bannerText" class="absolute bottom-5 left-8">Dagat naaa!</span>
          <button
            id="editBannerBtn"
            class="absolute top-5 right-5 z-10 bg-white/90 text-[#222] px-3 py-1.5 rounded-lg text-sm font-semibold opacity-0 group-hover:opacity-100 transition pointer-events-auto"
          >
            Edit Banner
          </button>
          <div id="bannerMenu" class="absolute top-14 right-5 bg-white shadow-lg rounded-lg w-44 p-2 space-y-1 hidden z-50">
            <button id="uploadImageBtn" class="w-full text-left px-3 py-2 rounded hover:bg-gray-100 text-sm font-medium">Upload Image</button>
          </div>
          <input type="file" id="bannerImageUpload" accept="image/*" class="hidden" />
        </div>

        <!-- PLAN TABS -->
        <div class="flex bg-white rounded-lg shadow p-0.5 mb-2 w-full">
          <a href="plan_feed.html" class="flex-1 text-gray-600 font-medium py-2 text-center hover:text-[#222] hover:bg-gray-100 rounded-lg">Feed</a>
          <a href="plan_budget.html" class="flex-1 bg-[#f4b41a] text-[#222] font-semibold py-2 text-center rounded-lg">Budget</a>
          <a href="plan_settings.html" class="flex-1 text-gray-600 font-medium py-2 text-center hover:text-[#222] hover:bg-gray-100 rounded-lg">Settings</a>
        </div>
      </div>


    <!-- LAYOUT: CONTENT + STICKY RIGHT SIDE -->
    <div class="flex gap-6">
      <!-- CONTENT -->
      <div class="flex-1 max-w-full">
        <!-- NO BUDGET VIEW -->
        <div id="noBudgetView" class="flex items-center justify-center h-[60vh]">
          <div class="text-center">
            <button id="openBudgetModal" class="bg-[#f4b41a] text-[#222] px-5 py-2 rounded-lg font-semibold shadow hover:bg-[#e3a918] transition">+ Set the budget</button>
            <p class="text-gray-500 mt-2 text-sm">Ready to set your plan's budget?</p>
          </div>
        </div>

        <!-- BUDGET VIEW -->
        <div id="budgetView" class="hidden space-y-4">
          <!-- SUMMARY CARDS -->
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
            <div class="bg-white rounded-xl p-5 shadow-sm border">
              <p class="text-sm text-gray-500">Estimated Budget</p>
              <p class="text-3xl font-bold text-gray-900" id="displayTotalBudget">₱0</p>
            </div>
            <div class="bg-white rounded-xl p-5 shadow-sm border">
              <p class="text-sm text-gray-500">Money Collected</p>
              <p class="text-3xl font-bold text-green-700" id="displayMoneyCollected">₱0</p>
            </div>
            <div class="bg-white rounded-xl p-5 shadow-sm border">
              <p class="text-sm text-gray-500">Not Collected</p>
              <p class="text-3xl font-bold text-orange-700" id="displayBalanceRemaining">₱0</p>
            </div>
          </div>

          <!-- PROGRESS -->
          <div class="bg-white rounded-xl p-5 shadow-sm border">
            <div class="flex justify-between items-center mb-3">
              <p class="text-sm font-semibold text-gray-700">Collection Progress</p>
              <p class="text-sm font-bold text-[#f4b41a]" id="progressPercentage">0%</p>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
              <div id="progressBar" class="bg-gradient-to-r from-[#f4b41a] to-[#f59e0b] h-4 rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
            </div>
            <p class="text-xs text-gray-500 mt-2">Click member payment status below to update</p>
          </div>

          <!-- EXPENSES -->
          <div class="bg-white rounded-xl p-5 shadow-sm border">
            <div class="flex justify-between items-center mb-5">
              <h3 class="text-xl font-bold text-[#222]">Expense Breakdown</h3>
              <button id="editExpensesBtn" class="text-[#f4b41a] hover:text-[#e3a918] font-medium text-sm flex items-center gap-1.5 px-3 py-1.5 rounded-lg hover:bg-yellow-50 transition">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
            </svg>
            Edit
          </button>
            </div>
            <div class="overflow-x-auto rounded-lg border border-gray-200">
              <table class="w-full text-sm">
                <thead class="bg-gray-50 border-b-2 border-gray-200">
                  <tr>
                    <th class="py-3 px-4 text-left font-semibold text-gray-700">Expense Item</th>
                    <th class="py-3 px-4 text-right font-semibold text-gray-700">Estimated</th>
                    <th class="py-3 px-4 text-right font-semibold text-gray-700">Actual Cost</th>
                    <th class="py-3 px-4 text-center font-semibold text-gray-700">Status</th>
                    <th class="py-3 px-4 w-10"></th>
                  </tr>
                </thead>
                <tbody id="expenseDisplayBody" class="divide-y divide-gray-100"></tbody>
                <tfoot class="border-t-2 bg-gradient-to-r from-gray-50 to-gray-100">
                  <tr>
                    <td class="py-4 px-4 font-bold text-gray-800">Total</td>
                    <td class="py-4 px-4 text-right font-bold text-gray-800" id="totalEstimated">₱0</td>
                    <td class="py-4 px-4 text-right font-bold text-gray-800" id="totalActual">₱0</td>
                    <td colspan="2"></td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>

          <!-- CONTRIBUTIONS -->
          <div class="bg-white rounded-xl p-5 shadow-sm border">
            <div class="flex justify-between items-center mb-5">
              <h3 class="text-xl font-bold text-[#222]">Member Contributions</h3>
              <button id="editContributionsBtn" class="text-[#f4b41a] hover:text-[#e3a918] font-medium text-sm flex items-center gap-1.5 px-3 py-1.5 rounded-lg hover:bg-yellow-50 transition">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
            </svg>
            Edit
          </button>
            </div>
            <div class="overflow-x-auto rounded-lg border border-gray-200">
              <table class="w-full text-sm">
                <thead class="bg-gray-50 border-b-2 border-gray-200">
                  <tr>
                    <th class="py-3 px-4 text-left font-semibold text-gray-700">Member</th>
                    <th class="py-3 px-4 text-right font-semibold text-gray-700">Amount Due</th>
                    <th class="py-3 px-4 text-center font-semibold text-gray-700">Payment Status</th>
                  </tr>
                </thead>
                <tbody id="contributionDisplayBody" class="divide-y divide-gray-100"></tbody>
              </table>
            </div>
            <p class="text-xs text-gray-500 mt-3 text-center">Tip: Click on payment status to toggle paid/unpaid</p>
          </div>
        </div>
      </div>

      <!-- RIGHT SIDEBAR -->
      <aside class="hidden lg:flex fixed top-10 right-12 bottom-4 w-80 flex-col space-y-4 overflow-y-auto no-scrollbar bg-[#fffaf2] z-20">
        <div id="membersCard" class="bg-white p-4 rounded-lg shadow">
          <h3 class="font-semibold mb-2">Members (9)</h3>
          <div class="grid grid-cols-5 gap-2 mb-3">
            <img src="Assets/Profile Icon/profile.png" class="w-8 h-8 rounded-full border" alt="">
            <img src="Assets/Profile Icon/profile2.png" class="w-8 h-8 rounded-full border" alt="">
            <img src="Assets/Profile Icon/profile3.png" class="w-8 h-8 rounded-full border" alt="">
            <img src="Assets/Profile Icon/profile4.png" class="w-8 h-8 rounded-full border" alt="">
            <img src="Assets/Profile Icon/profile5.png" class="w-8 h-8 rounded-full border" alt="">
            <img src="Assets/Profile Icon/profile6.png" class="w-8 h-8 rounded-full border" alt="">
            <img src="Assets/Profile Icon/profile7.png" class="w-8 h-8 rounded-full border" alt="">
            <img src="Assets/Profile Icon/profile8.png" class="w-8 h-8 rounded-full border" alt="">
            <img src="Assets/Profile Icon/profile.png" class="w-8 h-8 rounded-full border" alt="">
            <span class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-200 text-sm font-medium">+2</span>
          </div>
          <button onclick="openInvite()" class="w-full bg-[#f4b41a] text-[#222] py-2 rounded-lg font-medium hover:bg-[#e3a918] transition">Invite People</button>
        </div>
        <div class="bg-white p-4 rounded-lg shadow">
          <h3 class="font-semibold mb-2 flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-black" fill="currentColor" viewBox="0 0 24 24"><path d="M14 2l-1 1-5 5-4 1 6 6-5 5 1 1 5-5 6 6 1-4 5-5 1-1-10-10z"/></svg>
            Pinned
          </h3>
          <p class="text-sm text-gray-500">No pinned items yet.</p>
        </div>
      </aside>
    </div>

    <!-- BUDGET SETUP MODAL -->
    <div id="budgetModal" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-[65] hidden items-center justify-center">
      <div class="bg-white rounded-xl shadow-xl p-6 w-full max-w-md mx-auto relative">
        <div id="budgetHeader" class="flex justify-between items-center mb-4">
          <div class="flex flex-col">
            <p id="budgetStepLabel" class="text-sm text-gray-600">Step 1 of 3</p>
            <h2 id="budgetStepTitle" class="text-xl items-center font-semibold text-[#222]">Add Expenses</h2>
          </div>
          <button id="closeBudgetModal" class="text-gray-500 hover:text-black text-xl font-bold">&times;</button>
        </div>

        <!-- STEP 1 (LIST DOWN) -->
        <div id="budgetStep1" class="budget-step">
          <p class="text-gray-500 text-sm mb-3">List down your expected expenses below.</p>
          <table class="w-full text-sm border border-gray-200 rounded-lg overflow-hidden mb-3">
            <thead class="bg-gray-100">
              <tr><th class="py-2 px-3 text-left">Expense</th><th class="py-2 px-3 text-right">Estimated Cost (₱)</th></tr>
            </thead>
            <tbody id="expenseTableBody">
              <tr><td><input type="text" placeholder="e.g. Venue rental" class="w-full border-none p-2 outline-none"></td><td><input type="number" placeholder="0" class="w-full border-none p-2 text-right outline-none"></td></tr>
              <tr><td><input type="text" placeholder="e.g. Decorations" class="w-full border-none p-2 outline-none"></td><td><input type="number" placeholder="0" class="w-full border-none p-2 text-right outline-none"></td></tr>
              <tr><td><input type="text" placeholder="e.g. Entertainment" class="w-full border-none p-2 outline-none"></td><td><input type="number" placeholder="0" class="w-full border-none p-2 text-right outline-none"></td></tr>
              <tr><td><input type="text" placeholder="e.g. Food & drinks" class="w-full border-none p-2 outline-none"></td><td><input type="number" placeholder="0" class="w-full border-none p-2 text-right outline-none"></td></tr>
            </tbody>
          </table>

          <button id="addExpenseRow"
            class="mt-2 mb-4 w-full py-2.5 border-2 border-dashed border-gray-300 rounded-lg text-gray-600
                 hover:border-[#f4b41a] hover:text-[#f4b41a] hover:bg-yellow-50 transition font-medium
                 flex items-center justify-center gap-2">
             <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
             </svg>
            Add New Expense
          </button>
          
          <div class="flex justify-between items-center mt-2">
            <span class="font-medium text-gray-700">Total Estimated:</span>
            <span id="totalCost" class="font-semibold text-gray-800">₱0</span>
          </div>
          <div class="mt-6 flex justify-end">
            <button id="toStep2" class="bg-yellow-500 hover:bg-yellow-600 text-[#222] px-4 py-2 rounded-lg font-medium">Next</button>
          </div>
        </div>

        <!-- STEP 2 (LET'S DIVIDE) -->
        <div id="budgetStep2" class="budget-step hidden">
          <p class="text-sm text-gray-600 mb-4">Let's divide ₱<span id="totalEstimatedStep2">0</span> among your members.</p>
          <div class="space-y-2 mb-3">
            <label class="flex items-center gap-2"><input type="radio" name="division" value="equal" checked/><span>Split Equally</span></label>
            <label class="flex items-center gap-2"><input type="radio" name="division" value="custom"/><span>Custom Allocation</span></label>
          </div>
          <div class="overflow-x-auto border rounded-lg mb-3">
            <table class="w-full text-sm" id="memberTable">
              <thead class="bg-gray-100 text-left"><tr><th class="py-2 px-3">Member</th><th class="py-2 px-3 w-32">Amount (₱)</th><th class="py-2 px-3 w-10"></th></tr></thead>
              <tbody id="memberTableBody"></tbody>
              <tfoot class="border-t bg-gray-50"><tr><td class="py-2 px-3 font-semibold">Total</td><td class="py-2 px-3 font-semibold text-right" id="divisionTotal">₱0</td><td></td></tr></tfoot>
            </table>
          </div>
          <button id="addMemberBtn"
            class="mt-2 mb-4 w-full py-2.5 border-2 border-dashed border-gray-300 rounded-lg text-gray-600
                 hover:border-[#f4b41a] hover:text-[#f4b41a] hover:bg-yellow-50 transition font-medium
                 flex items-center justify-center gap-2">
             <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
             </svg>
            Add New Member
          </button>
          <div class="flex justify-between mt-4">
            <button id="backFromStep2" class="text-gray-600 hover:text-black px-4 py-2 rounded-lg font-medium">← Back</button>
            <button id="toStep3" class="bg-[#f4b41a] text-[#222] px-5 py-2 rounded-lg font-semibold hover:bg-[#e3a918] transition">Save & Continue →</button>
          </div>
        </div>

        <!-- STEP 3 (SUMMARY) -->
        <div id="budgetStep3" class="budget-step hidden">
          <p class="text-gray-500 text-sm mb-4">Here's a summary before saving your budget plan.</p>
          <div class="border border-gray-200 rounded-lg p-4 space-y-2 text-sm text-gray-700">
            <p><strong>Total Budget:</strong> <span id="summaryTotal">₱0</span></p>
            <p><strong>Division:</strong> <span id="summaryDivision">Split equally</span></p>
            <p><strong>Members:</strong> <span id="summaryMembers">0</span></p>
          </div>
          <div class="mt-6 flex justify-between">
            <button id="backToStep2" class="text-gray-600 hover:text-black px-4 py-2 rounded-lg font-medium">Back</button>
            <button id="saveBudgetPlan" class="bg-yellow-500 hover:bg-yellow-600 text-[#222] px-4 py-2 rounded-lg font-medium">Confirm & Save</button>
          </div>
        </div>
      </div>
    </div>

    <!-- INVITE MODAL -->
    <div id="inviteModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-[60]">
      <div class="bg-white w-96 rounded-xl shadow-lg p-6 relative">
        <h2 class="text-lg font-semibold mb-3">Invite People</h2>
        <button onclick="closeInvite()" class="absolute top-3 right-3 text-gray-500 hover:text-black">✕</button>
        <p class="text-sm text-gray-600 mb-3">Share this link with your friends to invite them to this plan:</p>
        <div class="flex items-center justify-between bg-gray-100 rounded-lg px-3 py-2 mb-3 border border-gray-300">
          <input id="inviteLink" type="text" readonly class="bg-transparent text-sm w-full focus:outline-none" value="" />
          <button onclick="copyLink()" class="ml-2 text-[#f4b41a] font-medium hover:underline">Copy</button>
        </div>
        <button onclick="generateLink()" class="w-full bg-[#f4b41a] text-[#222] py-2 rounded-lg font-medium hover:bg-[#e3a918] transition">Generate New Link</button>
      </div>
    </div>

  <!-- ADD: EDIT BANNER MODAL -->
  <div id="editBannerModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-[60]">
    <div class="edit-modal bg-white rounded-2xl shadow-xl p-5 relative">
      <button id="closeEditModal" class="absolute top-3 right-3 text-gray-500 hover:text-black">✕</button>

      <h3 class="text-lg font-semibold">Customize Banner</h3>
      <p class="text-sm text-gray-500 mb-4">Choose a color or upload an image for your banner</p>

      <p class="text-sm font-medium mb-2">Colors</p>
      <div id="colorSwatches" class="edit-modal-grid mb-4 relative"></div>

      <p class="text-sm font-medium mb-2">Image</p>
      <button id="uploadIconBtn" class="px-3 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 text-sm mb-4">Upload image</button>

      <p class="text-sm font-medium mb-2">Preview</p>
      <div id="bannerPreview" class="crop-aspect w-full rounded-lg overflow-hidden border border-gray-200 bg-gray-100 mb-4 flex items-end">
        <span class="m-3 text-white font-semibold drop-shadow">Banner preview</span>
      </div>

      <div class="flex justify-end gap-2">
        <button id="applyBannerBtn" class="px-4 py-2 rounded-lg bg-[#f4b41a] text-[#222] text-sm font-medium hover:bg-[#e3a918]">Apply</button>
      </div>
    </div>
  </div>

  <!-- ADD: CROP MODAL -->
  <div id="cropModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-[70]">
    <div class="bg-white rounded-2xl shadow-xl p-5 w-[min(90vw,820px)]">
      <h3 class="text-lg font-semibold mb-3">Crop Banner</h3>
      <div class="crop-aspect bg-gray-100 rounded-lg overflow-hidden">
        <img id="cropImage" alt="To crop" />
      </div>
      <div class="flex justify-end gap-2 mt-4">
        <button onclick="closeCropModal()" class="px-4 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 text-sm">Cancel</button>
        <button id="applyCropBtn" class="px-4 py-2 rounded-lg bg-[#f4b41a] text-[#222] text-sm font-medium hover:bg-[#e3a918]">Done</button>
      </div>
    </div>
  </div>

  <!-- SCRIPTS -->
  <script src="https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.js"></script>

      <script>
    // BANNER
    const banner = document.getElementById('planBanner');
    const bannerText = document.getElementById('bannerText');
    const editBannerBtn = document.getElementById('editBannerBtn');
    const bannerMenu = document.getElementById('bannerMenu');
    const bannerImageUpload = document.getElementById('bannerImageUpload');
    const resetBannerBtn = document.getElementById('resetBannerBtn');

    // MODAL ELEMENTS
    const editBannerModal = document.getElementById('editBannerModal');
    const closeEditModal = document.getElementById('closeEditModal');
    const colorSwatches = document.getElementById('colorSwatches');
    const uploadIconBtn = document.getElementById('uploadIconBtn');
    const bannerPreview = document.getElementById('bannerPreview');
    const applyBannerBtn = document.getElementById('applyBannerBtn');

    // MODAL HELPERS
    function initBannerPreviewFromCurrent() {
      if (!banner || !bannerPreview) return;
      const cs = getComputedStyle(banner);
      const bgImg = cs.backgroundImage;
      const bgCol = cs.backgroundColor;
      if (bgImg && bgImg !== 'none') {
        pending.type = 'image';
        pending.image = bgImg;
        pending.hex = null;
        pending.gradient = null;
        bannerPreview.style.backgroundImage = bgImg;
        bannerPreview.style.background = '';
      } else {
        pending.type = 'color';
        pending.hex = bgCol && bgCol !== 'rgba(0, 0, 0, 0)' ? bgCol : DEFAULT_SOLID;
        pending.image = null;
        pending.gradient = null;
        bannerPreview.style.backgroundImage = '';
        bannerPreview.style.background = pending.hex;
      }
      bannerPreview.style.backgroundSize = 'cover';
      bannerPreview.style.backgroundPosition = 'center';
    }
    function openEditModal() {
      if (!editBannerModal) return;
      editBannerModal.classList.remove('hidden');
      editBannerModal.classList.add('flex');
      initBannerPreviewFromCurrent();
    }
    function closeEditModalIfOpen() {
      if (!editBannerModal) return;
      editBannerModal.classList.add('hidden');
      editBannerModal.classList.remove('flex');
    }
    function closeCropModal() {
      if (!cropModal) return;
      cropModal.classList.add('hidden');
      cropModal.classList.remove('flex');
      if (cropper) { cropper.destroy(); cropper = null; }
    }

    // PENDING SELECTION STATE FOR MODAL
    const pending = { type: 'color', hex: '#3b82f6', image: null };

    // CROPPER MODAL
    let cropper;
    const cropModal = document.getElementById('cropModal');
    const cropImage = document.getElementById('cropImage');
    const applyCropBtn = document.getElementById('applyCropBtn');

    // DEFAULT ONLY IF NOTHING SET INLINE
    const DEFAULT_SOLID = '#3b82f6';
    (function ensureBannerHasBackground() {
      const cs0 = getComputedStyle(banner);
      const noImg = !cs0.backgroundImage || cs0.backgroundImage === 'none';
      const noCol = !cs0.backgroundColor || cs0.backgroundColor === 'rgba(0, 0, 0, 0)';
      if (noImg && noCol) {
        banner.style.background = DEFAULT_SOLID;
        banner.style.backgroundSize = 'cover';
        banner.style.backgroundPosition = 'center';
        banner.style.color = '#fff';
      }
    })();

    // HELPERS
    function hexToRgb(hex) {
      const h = hex.replace('#',''); const n = parseInt(h,16);
      if (h.length === 6) return { r:(n>>16)&255, g:(n>>8)&255, b:n&255 };
      if (h.length === 3) return { r:parseInt(h[0]+h[0],16), g:parseInt(h[1]+h[1],16), b:parseInt(h[2]+h[2],16) };
      return { r:0,g:0,b:0 };
    }
    function getBrightnessFromRgb({r,g,b}) { return (r*299+g*587+b*114)/1000; }
    function setTextColorForHex(hex) { banner.style.color = getBrightnessFromRgb(hexToRgb(hex)) < 140 ? '#fff' : '#222'; }
    function setTextColorForGradient(fromHex,toHex){
      const a=hexToRgb(fromHex), b=hexToRgb(toHex);
      const avg={r:((a.r+b.r)/2)|0, g:((a.g+b.g)/2)|0, b:((a.b+b.b)/2)|0};
      banner.style.color = getBrightnessFromRgb(avg) < 140 ? '#fff' : '#222';
    }

    // CLOSE SMALL MENU ON OUTSIDE CLICK
    document.addEventListener('click', (e) => { if (banner && !banner.contains(e.target)) bannerMenu.classList.add('hidden'); });
    // OPEN MODAL FROM EDIT BUTTON
    editBannerBtn?.addEventListener('click', (e) => { e.stopPropagation(); openEditModal(); });

    // PRESETS
    const gradients = [
      { name: "Ocean Breeze", from: "#00c6ff", to: "#0072ff" },
      { name: "Sunset Glow", from: "#ff7e5f", to: "#feb47b" },
      { name: "Royal Purple", from: "#8360c3", to: "#2ebf91" },
      { name: "Pink Dream", from: "#ff9a9e", to: "#fad0c4" },
      { name: "Mango Fiesta", from: "#f9d423", to: "#ff4e50" },
      { name: "Aqua Chill", from: "#13547a", to: "#80d0c7" },
      { name: "Midnight Sky", from: "#2c3e50", to: "#4ca1af" },
      { name: "Lush Meadow", from: "#56ab2f", to: "#a8e063" },
      { name: "Berry Punch", from: "#ff416c", to: "#ff4b2b" },
      { name: "Cosmic Violet", from: "#8e2de2", to: "#4a00e0" },
      { name: "Aurora Mist", from: "#f7971e", to: "#ffd200" },
      { name: "Minty Sky", from: "#83a4d4", to: "#b6fbff" }
    ];
    const solidColors = [
      '#222222','#000000','#ffffff','#f4b41a','#ef4444',
      '#22c55e','#06b6d4','#3b82f6','#8b5cf6','#94a3b8',
      '#10b981'
    ];

    // UNIFIED GRID
    if (colorSwatches) {
      const wrap = document.createElement('div');
      wrap.style.width = 'var(--swatch-size)';
      wrap.style.height = 'var(--swatch-size)';
      wrap.style.position = 'relative';

      const pickerBtn = document.createElement('button');
      pickerBtn.className = 'color-picker-circle picker-donut';
      pickerBtn.title = 'Custom color';
      wrap.appendChild(pickerBtn);

      const pop = document.createElement('div');
      pop.className = 'swatch-popover hidden';
      pop.innerHTML = `<input id="inlinePicker" type="color" value="#3b82f6" style="width: 160px; height: 36px; border: 0; background: transparent; padding: 0;"/>`;
      wrap.appendChild(pop);
      colorSwatches.appendChild(wrap);

      const inlinePicker = pop.querySelector('#inlinePicker');

      function hidePop() { pop.classList.add('hidden'); }
      function showPop() { pop.classList.remove('hidden'); inlinePicker?.focus(); }

      pickerBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        pop.classList.toggle('hidden');
      });
      document.addEventListener('click', (e) => {
        if (!pop.contains(e.target) && e.target !== pickerBtn) hidePop();
      });

      inlinePicker?.addEventListener('input', () => {
        const hex = inlinePicker.value;
        pending.type = 'color';
        pending.hex = hex;
        pending.image = null;
        pending.gradient = null;
        if (bannerPreview) {
          bannerPreview.style.backgroundImage = '';
          bannerPreview.style.background = hex;
          bannerPreview.style.backgroundSize = 'cover';
          bannerPreview.style.backgroundPosition = 'center';
        }
      });
      inlinePicker?.addEventListener('change', hidePop);

      solidColors.slice(0,12).forEach((hex) => {
        const sw = document.createElement('button');
        sw.className = 'color-picker-circle';
        sw.title = hex;
        sw.style.background = hex;
        sw.addEventListener('click', () => {
          pending.type = 'color';
          pending.hex = hex;
          pending.image = null;
          pending.gradient = null;
          if (bannerPreview) {
            bannerPreview.style.backgroundImage = '';
            bannerPreview.style.background = hex;
            bannerPreview.style.backgroundSize = 'cover';
            bannerPreview.style.backgroundPosition = 'center';
          }
          hidePop();
        });
        colorSwatches.appendChild(sw);
      });

      gradients.slice(0,12).forEach(g => {
        const btn = document.createElement('button');
        btn.className = 'gradient-circle';
        btn.title = g.name;
        btn.style.background = `linear-gradient(90deg, ${g.from}, ${g.to})`;
        btn.addEventListener('click', () => {
          pending.type = 'gradient';
          pending.gradient = `linear-gradient(to right, ${g.from}, ${g.to})`;
          pending.hex = null; pending.image = null; pending.from = g.from; pending.to = g.to;
          if (bannerPreview) {
            bannerPreview.style.backgroundImage = 'none';
            bannerPreview.style.background = pending.gradient;
            bannerPreview.style.backgroundSize = 'cover';
            bannerPreview.style.backgroundPosition = 'center';
          }
          hidePop();
        });
        colorSwatches.appendChild(btn);
      });
    }

    // CLOSE SMALL MENU ON OUTSIDE CLICK
    document.addEventListener('click', (e) => { if (banner && !banner.contains(e.target)) bannerMenu.classList.add('hidden'); });
    // OPEN MODAL FROM EDIT BUTTON
    editBannerBtn?.addEventListener('click', (e) => { e.stopPropagation(); openEditModal(); });

    // UPLOAD, CROP, PREVIEW
    uploadIconBtn?.addEventListener('click', () => { bannerImageUpload?.click(); });

    bannerImageUpload?.addEventListener('change', (e) => {
      const file = e.target.files?.[0]; if (!file || !cropImage) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        cropImage.src = ev.target.result;
        cropModal.classList.remove('hidden'); cropModal.classList.add('flex');
        if (cropper) cropper.destroy();
        cropper = new Cropper(cropImage, { aspectRatio: 21/9, viewMode: 1, autoCropArea: 1, responsive: true, background: false, dragMode: 'move' });
      };
      reader.readAsDataURL(file);
    });

    applyCropBtn?.addEventListener('click', () => {
      if (!cropper || !bannerPreview) return;
      const canvas = cropper.getCroppedCanvas({ width: 2000, height: 800 });
      const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
      pending.type = 'image';
      pending.image = `url("${dataUrl}")`;

     // LOAD DATAURL INTO IMAGE FIRST
     const img = new Image();
     img.onload = () => {
       bannerPreview.style.backgroundImage = `url("${dataUrl}")`;
       bannerPreview.style.backgroundColor = 'transparent';
       bannerPreview.style.backgroundRepeat = 'no-repeat';
       bannerPreview.style.backgroundSize = 'cover';
       bannerPreview.style.backgroundPosition = 'center';
       bannerPreview.style.minHeight = '120px';
       bannerPreview.classList.remove('bg-gray-100');
       const txt = bannerPreview.querySelector('span');
       if (txt) txt.style.display = 'none';
     };
     img.onerror = () => showToast('Failed to generate preview');
     img.src = dataUrl;
      closeCropModal();
    });
    // WIRE MODAL CLOSE BEHAVIORS
   closeEditModal?.addEventListener('click', closeEditModalIfOpen);
   editBannerModal?.addEventListener('click', (e)=>{ if (e.target === editBannerModal) closeEditModalIfOpen(); });
   document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') closeEditModalIfOpen(); });

    // APPLY, WRITE PREVIEW TO THE BANNER; DONE, JUST CLOSE
   applyBannerBtn?.addEventListener('click', () => {
     if (!banner) return;
     if (pending.type === 'image' && pending.image) {
       banner.style.background = '';
       banner.style.backgroundImage = pending.image;
       banner.style.backgroundRepeat = 'no-repeat';
       banner.style.backgroundSize = 'cover';
       banner.style.backgroundPosition = 'center';
       banner.style.color = '#fff';
     } else if (pending.type === 'color' && pending.hex) {
       banner.style.backgroundImage = 'none';
       banner.style.background = pending.hex;
       banner.style.backgroundSize = 'cover';
       banner.style.backgroundPosition = 'center';
       setTextColorForHex(pending.hex);
     } else if (pending.type === 'gradient' && pending.gradient) {
       banner.style.backgroundImage = 'none';
       banner.style.background = pending.gradient;
       banner.style.backgroundSize = 'cover';
       banner.style.backgroundPosition = 'center';
       if (pending.from && pending.to) setTextColorForGradient(pending.from, pending.to);
       else banner.style.color = '#fff';
     }
     closeEditModalIfOpen();
   });
</script>


  <script>
  // TOAST NOTIFICATION
    function showToast(msg){
    const t = document.createElement('div');
    t.className = 'fixed bottom-5 right-5 bg-[#222] text-sm text-white px-4 py-2 rounded-lg shadow opacity-0 translate-y-2 transition-all duration-300 z-[9999]';
    t.textContent = msg;
    document.body.appendChild(t);
    // TRIGGER ENTER ANIMATION
    requestAnimationFrame(() => {
      t.classList.remove('opacity-0','translate-y-2');
      t.classList.add('opacity-100','translate-y-0');
    });
    
    setTimeout(() => {
    t.classList.remove('opacity-100','translate-y-0');
    t.classList.add('opacity-0','translate-y-2');
    setTimeout(()=> t.remove(), 300);
    }, 2500);
 }

    // HELPER TO SYNC STICKY
    function syncStickySpacer(){
      const header = document.getElementById('stickyHeader');
      const spacer = document.getElementById('stickySpacer');
      if (!header || !spacer) return;
      spacer.style.height = header.offsetHeight + 'px';
    }

    // WIZARD
    document.addEventListener("DOMContentLoaded", () => {
      const modal = document.getElementById("budgetModal");
      const openBtn = document.getElementById("openBudgetModal");
      const closeBtn = document.getElementById("closeBudgetModal");
      const steps = [
        { id: "budgetStep1", title: "Add Expenses" },
        { id: "budgetStep2", title: "Set Division" },
        { id: "budgetStep3", title: "Confirm Plan" }
      ];
      let currentStep = 0;
      const stepLabel = document.getElementById("budgetStepLabel");
      const stepTitle = document.getElementById("budgetStepTitle");

      function showStep(i){
        steps.forEach((s,idx)=>document.getElementById(s.id).classList.toggle("hidden", idx!==i));
        stepLabel.textContent = `Step ${i+1} of 3`;
        stepTitle.textContent = steps[i].title;
      }

     // ENSURE SPACER IS CORRECT AFTER UI PAINTS
     syncStickySpacer();
     window.addEventListener('resize', syncStickySpacer);

      openBtn?.addEventListener('click', ()=>{ modal.classList.remove('hidden'); modal.classList.add('flex'); currentStep=0; showStep(currentStep); });
      closeBtn?.addEventListener('click', ()=>{ modal.classList.add('hidden'); modal.classList.remove('flex'); currentStep=0; showStep(currentStep); });
      modal?.addEventListener('click', (e)=>{ if (e.target===modal){ closeBtn.click(); }});

      const eventMembers = [
        { name: "Juan Dela Cruz", username: "@juan_dc", avatar: "Assets/Profile Icon/profile.png" },
        { name: "Maria Santos", username: "@maria_s", avatar: "Assets/Profile Icon/profile2.png" },
        { name: "Pedro Reyes", username: "@pedro_r", avatar: "Assets/Profile Icon/profile3.png" },
        { name: "Ana Garcia", username: "@ana_g", avatar: "Assets/Profile Icon/profile4.png" }
      ];
      let memberCounter = eventMembers.length;
      let budgetData = null;

      function initMemberList() {
        const tbody = document.getElementById("memberTableBody");
        const divisionType = document.querySelector('input[name="division"]:checked').value;
        const total = parseFloat((document.getElementById("totalCost").textContent || '0').replace(/[₱,]/g,'')) || 0;
        tbody.innerHTML = "";
        memberCounter = eventMembers.length;
        eventMembers.forEach(m=>{
          const amount = divisionType==="equal" ? (total/eventMembers.length).toFixed(2) : "0.00";
          addMemberRow(m, amount, divisionType);
        });
        updateDivisionTotal();
      }

      function addMemberRow(member, amount="0.00", divisionType=null){
        const tbody = document.getElementById("memberTableBody");
        const currentDivision = divisionType || document.querySelector('input[name="division"]:checked').value;
        const isReadOnly = currentDivision === "equal";
        const row = document.createElement("tr");
        row.className = "border-t";
        row.innerHTML = `
          <td class="py-2 px-3">
            <div class="flex items-center gap-2">
              <img src="${member.avatar||'Assets/Profile Icon/profile.png'}" class="w-6 h-6 rounded-full border" alt="">
              <div class="flex-1">
                <input type="text" value="${member.name}" class="text-sm font-medium w-full border-none outline-none p-0 member-name" placeholder="Member name">
                ${member.username?`<div class="text-xs text-gray-500">${member.username}</div>`:''}
              </div>
            </div>
          </td>
          <td class="py-2 px-3">
            <input type="number" value="${amount}" class="w-full border rounded px-2 py-1 text-right member-amount ${isReadOnly?'bg-gray-100 cursor-not-allowed':''}" placeholder="0.00" step="0.01" min="0" ${isReadOnly?'readonly':''}>
          </td>
          <td class="py-2 px-3 text-center">
            <button class="text-red-500 hover:text-red-700 delete-member" title="Remove member">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
          </td>`;

        tbody.appendChild(row);
        if (!isReadOnly) row.querySelector('.member-amount').addEventListener('input', updateDivisionTotal);
        row.querySelector('.delete-member').addEventListener('click', ()=>{
          row.remove();
          if ((document.querySelector('input[name="division"]:checked')?.value) === "equal") recalcEqualSplit();
          updateDivisionTotal();
        });
      }

      function recalcEqualSplit(){
        const total = parseFloat((document.getElementById("totalCost").textContent||'0').replace(/[₱,]/g,''))||0;
        const inputs = document.querySelectorAll('.member-amount');
        const n = inputs.length || 1; const per = (total/n).toFixed(2);
        inputs.forEach(inp=>inp.value = per);
      }

      function updateDivisionTotal(){
        let sum = 0; document.querySelectorAll('.member-amount').forEach(i=>sum += parseFloat(i.value)||0);
        const out = document.getElementById("divisionTotal");
        if (out) out.textContent = `₱${sum.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}`;
      }

      document.querySelectorAll('input[name="division"]').forEach(r=>{
        r.addEventListener('change', ()=>{
          const type = r.value;
          const inputs = document.querySelectorAll('.member-amount');
          if (type==="equal"){ recalcEqualSplit(); inputs.forEach(i=>{ i.readOnly=true; i.classList.add('bg-gray-100','cursor-not-allowed'); }); }
          else { inputs.forEach(i=>{ i.readOnly=false; i.classList.remove('bg-gray-100','cursor-not-allowed'); }); }
          updateDivisionTotal();
        });
      });

      document.getElementById("addMemberBtn").addEventListener('click', ()=>{
        memberCounter++;
        const type = document.querySelector('input[name="division"]:checked').value;
        const total = parseFloat((document.getElementById("totalCost").textContent||'0').replace(/[₱,]/g,''))||0;
        const newMember = { name:`Member ${memberCounter}`, username:"", avatar:"Assets/Profile Icon/profile.png" };
        let amount = "0.00";
        if (type==="equal"){ const current = document.querySelectorAll('.member-amount').length; amount = (total/(current+1)).toFixed(2); }
        addMemberRow(newMember, amount, type);
        if (type==="equal") recalcEqualSplit();
        updateDivisionTotal();
      });

      document.getElementById("toStep2").addEventListener('click', ()=>{
        currentStep = 1; showStep(currentStep);
        const numeric = parseFloat((document.getElementById("totalCost").textContent||'0').replace(/[₱,]/g,''))||0;
        document.getElementById("totalEstimatedStep2").innerText = numeric.toLocaleString();
        initMemberList();
      });
      document.getElementById("backFromStep2").addEventListener('click', ()=>{ currentStep = 0; showStep(currentStep); });
      document.getElementById("toStep3").addEventListener('click', ()=>{
        document.getElementById("summaryTotal").textContent = document.getElementById("totalCost").textContent;
        const divType = document.querySelector("input[name='division']:checked").value;
        document.getElementById("summaryDivision").textContent = divType==="equal" ? "Split equally" : "Custom amounts";
        document.getElementById("summaryMembers").textContent = document.querySelectorAll('.member-amount').length;
        currentStep = 2; showStep(currentStep);
      });
      document.getElementById("backToStep2").addEventListener('click', ()=>{ currentStep = 1; showStep(currentStep); });

      document.getElementById("saveBudgetPlan").addEventListener('click', ()=>{
        // BUILD BUDGET DATA AND SHOW BUDGET VIEW
        const expenses = [];
        document.querySelectorAll('#expenseTableBody tr').forEach(row=>{
          const name = row.querySelector('input[type="text"]')?.value?.trim() || "Untitled Expense";
          const est = parseFloat(row.querySelector('input[type="number"]')?.value || "0") || 0;
          if (name || est) expenses.push({ name, estimated: est, actual: 0, paid: false });
        });
        const contributions = [];
        document.querySelectorAll('#memberTableBody tr').forEach(row=>{
          const name = row.querySelector('.member-name')?.value || 'Member';
          const amt = parseFloat(row.querySelector('.member-amount')?.value || "0") || 0;
          const avatar = row.querySelector('img')?.src || "Assets/Profile Icon/profile.png";
          contributions.push({ name, amount: amt, paid: false, avatar });
        });
        budgetData = { expenses, contributions, totalBudget: expenses.reduce((s,e)=>s+e.estimated,0) };
        renderBudget();
        modal.classList.add('hidden'); modal.classList.remove('flex'); currentStep=0; showStep(currentStep);
      });

      // STEP 1 TABLE
      const expenseTable = document.getElementById("expenseTableBody");

      // Prevent decimals in estimated cost inputs
      function blockDecimals(input) {
        if (!input) return;
        input.addEventListener('input', function () {
          // remove any non-digit characters (block decimal points and commas)
          this.value = this.value.replace(/\D/g, '');
        });
        input.addEventListener('keydown', function (e) {
          if (e.key === '.' || e.key === ',') e.preventDefault();
        });
      }

      // apply to existing number inputs
      expenseTable.querySelectorAll("input[type='number']").forEach(blockDecimals);

      // add new expense row and ensure decimal-blocking is applied
      document.getElementById("addExpenseRow").addEventListener("click", ()=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `<td><input type="text" placeholder="e.g. New expense" class="w-full border-none p-2 outline-none"></td>
                        <td><input type="number" placeholder="0" class="w-full border-none p-2 text-right outline-none"></td>`;
        expenseTable.appendChild(tr);
        const newInput = tr.querySelector('input[type="number"]');
        blockDecimals(newInput);
      });

      // recalc total when any number input changes
      expenseTable.addEventListener("input", ()=>{
        let total = 0;
        expenseTable.querySelectorAll("input[type='number']").forEach(i=>{ total += parseFloat(i.value)||0; });
        document.getElementById("totalCost").textContent = `₱${total.toLocaleString()}`;
      });

      // DISPLAY BUDGET
      function renderBudget(){
        if (!budgetData) return;
        document.getElementById('noBudgetView').classList.add('hidden');
        document.getElementById('budgetView').classList.remove('hidden');
        updateSummaryCards(); renderExpenseTable(); renderContributionTable();
      }
      function updateSummaryCards(){
        const total = budgetData.totalBudget;
        const collected = budgetData.contributions.filter(c=>c.paid).reduce((s,c)=>s+c.amount,0);
        const remain = Math.max(0, total - collected);
        const pct = total>0 ? Math.round((collected/total)*100) : 0;
        document.getElementById('displayTotalBudget').textContent = `₱${total.toLocaleString()}`;
        document.getElementById('displayMoneyCollected').textContent = `₱${collected.toLocaleString()}`;
        document.getElementById('displayBalanceRemaining').textContent = `₱${remain.toLocaleString()}`;
        document.getElementById('progressPercentage').textContent = `${pct}%`;
        document.getElementById('progressBar').style.width = `${pct}%`;
      }

      function renderExpenseTable(){
        const tbody = document.getElementById('expenseDisplayBody'); tbody.innerHTML = '';
        budgetData.expenses.forEach((e,idx)=>{
          const tr = document.createElement('tr'); tr.className='hover:bg-gray-50';
          tr.innerHTML = `
            <td class="py-3 px-4 font-medium text-gray-700">${e.name}</td>
            <td class="py-3 px-4 text-right text-gray-600">₱${e.estimated.toLocaleString()}</td>
            <td class="py-3 px-4 text-right">
              <input type="number" value="${e.actual||0}" class="w-20 border rounded px-2 py-1 text-right actual-cost-input text-sm" data-index="${idx}" step="0.01" min="0">
            </td>
            <td class="py-3 px-4 text-center">
              <span class="status-badge inline-block px-3 py-1.5 rounded-full text-xs font-semibold ${e.paid?'bg-green-100 text-green-700':'bg-yellow-100 text-yellow-700'} expense-status-badge" data-index="${idx}">
                ${e.paid?'✓ Paid':'Pending'}
              </span>
            </td>
            <td class="py-3 px-4 text-center">
              <button class="text-red-400 hover:text-red-600 delete-expense-btn" data-index="${idx}">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
              </button>
            </td>`;

          tbody.appendChild(tr);
        });

        document.querySelectorAll('.actual-cost-input').forEach(inp=>{
          inp.addEventListener('change', e=>{
            const i = +e.target.dataset.index; budgetData.expenses[i].actual = parseFloat(e.target.value)||0; updateExpenseTotals();
          });
        });
        document.querySelectorAll('.expense-status-badge').forEach(b=>{
          b.addEventListener('click', e=>{
            const i = +e.target.dataset.index; const v = budgetData.expenses[i]; v.paid = !v.paid;
            e.target.className = `status-badge inline-block px-3 py-1.5 rounded-full text-xs font-semibold ${v.paid?'bg-green-100 text-green-700':'bg-yellow-100 text-yellow-700'} expense-status-badge`;
            e.target.textContent = v.paid ? '✓ Paid' : 'Pending';
            showToast(v.paid ? '✓ Expense marked as paid' : 'Expense marked as pending');
          });
        });
        document.querySelectorAll('.delete-expense-btn').forEach(btn=>{
          btn.addEventListener('click', e=>{
            const i = +(e.currentTarget.dataset.index); budgetData.expenses.splice(i,1);
            renderExpenseTable(); updateExpenseTotals(); showToast('Expense removed');
          });
        });
        updateExpenseTotals();
      }
      function updateExpenseTotals(){
        const totalEst = budgetData.expenses.reduce((s,e)=>s+e.estimated,0);
        const totalAct = budgetData.expenses.reduce((s,e)=>s+(e.actual||0),0);
        document.getElementById('totalEstimated').textContent = `₱${totalEst.toLocaleString()}`;
        document.getElementById('totalActual').textContent = `₱${totalAct.toLocaleString()}`;
      }

      function renderContributionTable(){
        const tbody = document.getElementById('contributionDisplayBody'); tbody.innerHTML = '';
        budgetData.contributions.forEach((m,idx)=>{
          const tr = document.createElement('tr'); tr.className='hover:bg-gray-50';
          tr.innerHTML = `
            <td class="py-3 px-4"><div class="flex items-center gap-3">
              <img src="${m.avatar}" class="w-10 h-10 rounded-full border-2 border-gray-200" alt=""><span class="font-medium text-gray-700">${m.name}</span></div>
            </td>
            <td class="py-3 px-4 text-right font-semibold text-gray-800">₱${m.amount.toLocaleString()}</td>
            <td class="py-3 px-4 text-center">
              <span class="status-badge inline-block px-4 py-2 rounded-full text-xs font-bold ${m.paid?'bg-green-100 text-green-700':'bg-orange-100 text-orange-700'} member-payment-badge" data-index="${idx}">
                ${m.paid?'✓ Paid':'Unpaid'}
              </span>
            </td>`;
          tbody.appendChild(tr);
        });
        document.querySelectorAll('.member-payment-badge').forEach(b=>{
          b.addEventListener('click', e=>{
            const i = +e.target.dataset.index; const v = budgetData.contributions[i]; v.paid = !v.paid;
            e.target.className = `status-badge inline-block px-4 py-2 rounded-full text-xs font-bold ${v.paid?'bg-green-100 text-green-700':'bg-orange-100 text-orange-700'} member-payment-badge`;
            e.target.textContent = v.paid ? '✓ Paid' : 'Unpaid';
            updateSummaryCards();
            showToast(v.paid ? `✓ ${v.name} marked as paid!` : `${v.name} marked as unpaid`);
          });
        });
      }

  // EDIT BUTTONS
  let editOnlyMode = false;

      function toggleWizardControls(visible) {
        ['toStep2','backFromStep2','toStep3','backToStep2','saveBudgetPlan'].forEach(id=>{
          const el = document.getElementById(id);
          if (!el) return;
          el.style.display = visible ? '' : 'none';
        });
      }

      function ensureApplyButton() {
        let btn = document.getElementById('applyEditsBtn');
        if (btn) return btn;
        btn = document.createElement('button');
        btn.id = 'applyEditsBtn';
        btn.className = 'mt-4 bg-[#f4b41a] text-[#222] px-4 py-2 rounded-lg font-medium';
        btn.textContent = 'Apply Changes';
        btn.addEventListener('click', applyEditsAndClose);
        const container = document.querySelector('#budgetModal > div');
        if (container) container.appendChild(btn);
        return btn;
      }
      function enterEditModal(step = 0) {
        if (!budgetData) return;
        editOnlyMode = true;
        populateExpensesForEdit();
        populateContributionsForEdit();
        currentStep = step;
        showStep(currentStep);
        toggleWizardControls(false);
        ensureApplyButton().style.display = '';
        modal.classList.remove('hidden');
        modal.classList.add('flex');
      }

      function exitEditMode() {
        editOnlyMode = false;
        toggleWizardControls(true);
        const b = document.getElementById('applyEditsBtn');
        if (b) b.style.display = 'none';
      }
      function applyEditsAndClose() {
        // READ MODAL INPUTS AND UPDATE BUDGET DATA
        const expenses = [];
        document.querySelectorAll('#expenseTableBody tr').forEach(row=>{
          const name = row.querySelector('input[type="text"]')?.value?.trim() || "Untitled Expense";
          const est = parseFloat(row.querySelector('input[type="number"]')?.value || "0") || 0;
          expenses.push({ name, estimated: est, actual: 0, paid: false });
        });
        const contributions = [];
        document.querySelectorAll('#memberTableBody tr').forEach(row=>{
          const name = row.querySelector('.member-name')?.value || 'Member';
          const amt = parseFloat(row.querySelector('.member-amount')?.value || "0") || 0;
          const avatar = row.querySelector('img')?.src || "Assets/Profile Icon/profile.png";
          contributions.push({ name, amount: amt, paid: false, avatar });
        });
        budgetData = { expenses, contributions, totalBudget: expenses.reduce((s,e)=>s+e.estimated,0) };
        renderBudget();
        modal.classList.add('hidden'); modal.classList.remove('flex');
        currentStep = 0; showStep(currentStep);
        exitEditMode();
      }
      // LOCAL POPULATE FUNCTIONS
      function populateExpensesForEdit() {
        const tbody = document.getElementById('expenseTableBody');
        if (!tbody || !budgetData) return;
        tbody.innerHTML = '';
        budgetData.expenses.forEach(expense => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td><input type="text" value="${expense.name}" class="w-full border-none p-2 outline-none"></td>
            <td><input type="number" value="${expense.estimated}" class="w-full border-none p-2 text-right outline-none"></td>
          `;
          tbody.appendChild(row);
        });

        tbody.dispatchEvent(new Event('input'));
      }
      function populateContributionsForEdit() {
        const tbody = document.getElementById('memberTableBody');
        if (!tbody || !budgetData) return;
        tbody.innerHTML = '';
        budgetData.contributions.forEach(member => {
          const memberData = { name: member.name, username: '', avatar: member.avatar };
          addMemberRow(memberData, (member.amount||0).toFixed(2), 'custom');
        });
        updateDivisionTotal();
      }

      // WIRE EDIT BUTTONS TO OPEN EDIT-ONLY MODAL
      document.getElementById('editExpensesBtn')?.addEventListener('click', () => { enterEditModal(0); });
      document.getElementById('editContributionsBtn')?.addEventListener('click', () => {
        document.getElementById("totalEstimatedStep2").innerText = (budgetData?.totalBudget||0).toLocaleString();
        enterEditModal(1);
      });

      // HIDE APPLY BUTTON BY DEFAULT
      const _btn = document.getElementById('applyEditsBtn'); if (_btn) _btn.style.display = 'none';
      
    });


    // INVITE PEOPLE
    const inviteModal = document.getElementById('inviteModal');
    const inviteLinkInput = document.getElementById('inviteLink');

    function openInvite() {
      inviteModal?.classList.remove('hidden');
      inviteModal?.classList.add('flex');
      generateLink();
    }

    function closeInvite() {
      inviteModal?.classList.add('hidden');
      inviteModal?.classList.remove('flex');
    }

    function generateLink() {
      const uniqueCode = Math.random().toString(36).substring(2, 10);
      const inviteLink = `https://dinadrawing.com/invite/${uniqueCode}`;
      if (inviteLinkInput) inviteLinkInput.value = inviteLink;
    }

    function copyLink() {
      const text = inviteLinkInput?.value || '';
      if (navigator.clipboard?.writeText) {
        navigator.clipboard.writeText(text).then(() => alert('Copied to clipboard!'));
      } else if (inviteLinkInput) {
        inviteLinkInput.select();
        document.execCommand('copy');
        alert('Copied to clipboard!');
      }
    }
</script>



  <script>
    (function(){
      const banner = document.getElementById('planBanner');
      const members = document.getElementById('membersCard');
      const spacerApply = () => { try { syncStickySpacer(); } catch (e) {} };

      if (banner && members) {
        const mq = window.matchMedia('(min-width: 1024px)');
        const apply = () => {
          if (!mq.matches) {
            banner.style.height = '';
            spacerApply();
            return;
          }
          const h = members.offsetHeight;
          if (h > 0) banner.style.height = h + 'px';
          spacerApply();
        };
        const ro = new ResizeObserver(apply);
        ro.observe(members);
        (mq.addEventListener ? mq.addEventListener('change', apply) : mq.addListener(apply));
        window.addEventListener('load', apply);
        window.addEventListener('resize', apply);
        apply();
      } else {
        spacerApply();
      }
    })();
  </script>
</body>
</html>